# ========== 1. Server Basic Configuration ==========
[server]
config_version = "v1.0.0"
tunnel_port = 50001
http_entry_port = 8001
grpc_entry_port = 8002
log_level = "info"
trace_enabled = false

# ========== 2. Forward Upstreams Definition ==========
[forward.upstreams.backend]
servers = [
    { address = "https://echo.free.beeceptor.com", resolve = true }
]
lb_policy = "round_robin"

[forward.upstreams.grpc_backend]
servers = [
    { address = "127.0.0.1:9002", resolve = false }
]
lb_policy = "round_robin"

# ========== 3. Forward Request from Client Proxy Configuration ==========
[[forward.rules.http]]
match_host = "echo.free.beeceptor.com"
action_upstream = "backend"

[[forward.rules.grpc]]
match_host = "grpc.backend.com"
match_service = "com.example.BackendService"
action_upstream = "grpc_backend"

# ========== 4. Reverse Proxy (Tunnel/Client Group) for Server to Client Configuration ==========
[[reverse_proxy.rules.http]]
match_host = "www.google.com"
action_client_group = "group-a"

[[reverse_proxy.rules.http]]
match_host = "www2.google.com"
action_client_group = "group-b"

[[reverse_proxy.rules.grpc]]
match_host = "grpc.google.com"
match_service = "com.example.MyService"
action_client_group = "group-a"

# ========== 5. Client Group Configuration (Distributed to client) client to outside ==========
[reverse_proxy.client_groups.group-a]
config_version = "v1.0.0"

[reverse_proxy.client_groups.group-a.upstreams.local_service]
servers = [
    { address = "https://echo.free.beeceptor.com", resolve = true }
    # { address = "https://google.com", resolve = true }
]
lb_policy = "round_robin"

[[reverse_proxy.client_groups.group-a.rules.http]]
match_host = "www.google.com"
action_upstream = "local_service"
# action_set_host = "www.google.com"

[[reverse_proxy.client_groups.group-b.rules.http]]
match_host = "www.google.com"
action_upstream = "local_service"

# # You can also configure HTTP services
# [client_groups.group-a.upstreams.http_service]
# servers = [
#     { address = "http://127.0.0.1:8080", resolve = false }
# ]
# lb_policy = "round_robin"

# [[client_groups.group-a.rules.http]]
# match_host = "localhost"
# action_upstream = "http_service"

[reverse_proxy.client_groups.group-b]
config_version = "v1.0.0"

[reverse_proxy.client_groups.group-b.upstreams.local_service]
servers = [
    { address = "127.0.0.1:9100", resolve = false }
]
lb_policy = "round_robin"

# [[client_groups.group-b.rules.http]]
# match_host = "b.com"
# action_upstream = "local_service"