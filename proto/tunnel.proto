syntax = "proto3";

package tunnel;

service TunnelService {
  rpc ControlStream(stream TunnelMessage) returns (stream TunnelMessage);
  rpc Proxy(stream TunnelMessage) returns (stream TunnelMessage);
  rpc ConfigSync(ConfigSyncRequest) returns (ConfigSyncResponse);
}

message TunnelMessage {
  string client_id = 1;
  string request_id = 2;
  Direction direction = 3;  // Request direction
  oneof payload {
    HttpRequest http_request = 4;
    HttpResponse http_response = 5;
    GrpcRequest grpc_request = 6;
    GrpcResponse grpc_response = 7;
    ConfigSyncRequest config_sync = 8;
    ConfigSyncResponse config_sync_response = 9;
    StreamOpenRequest stream_open = 10;
    StreamOpenResponse stream_open_response = 11;
    ErrorMessage error_message = 12;
  }
  string trace_id = 15;
}

enum Direction {
  CLIENT_TO_SERVER = 0;  // client initiates, server processes
  SERVER_TO_CLIENT = 1;  // server initiates, client processes
}

message HttpRequest {
  string stream_id = 1;
  string method = 2;
  string url = 3;
  string host = 4;
  string path = 5;
  string query = 6;
  map<string, string> headers = 7;
  bytes body = 8;
  string original_dst = 9;
}

message HttpResponse {
  int32 status_code = 1;
  map<string, string> headers = 2;
  bytes body = 3;
}

message GrpcRequest {
  string stream_id = 1;
  string service = 2;
  string method = 3;
  string host = 4;
  map<string, string> headers = 5;
  map<string, string> metadata = 6;
  bytes body = 7;
  string original_dst = 8;
}

message GrpcResponse {
  int32 status_code = 1;
  map<string, string> headers = 2;
  bytes body = 3;
}

message ConfigSyncRequest {
  string client_id = 1;
  string group = 2;
  string config_version = 3;
}

message ConfigSyncResponse {
  string config_version = 1;
  repeated Rule rules = 2;
  repeated Upstream upstreams = 3;
}

message Rule {
  string rule_id = 1;
  string type = 2; // http/grpc
  string match_host = 3;
  string match_path_prefix = 4;
  string match_service = 5; // grpc
  map<string, string> match_header = 6;
  string action_proxy_pass = 7;
  string action_set_host = 8;
  string action_upstream = 9;
  bool   action_ssl = 10;
  // 可扩展更多 action 字段
}

message Upstream {
  string name = 1;
  repeated UpstreamServer servers = 2;
  string lb_policy = 3;
}

message UpstreamServer {
  string address = 1;
  bool resolve = 2;
}

message StreamOpenRequest {
  string client_id = 1;
  string group = 2;
  string version = 3;
  string stream_id = 4;
  StreamType stream_type = 5;
  int64 timestamp = 6;
}

message StreamOpenResponse {
  bool success = 1;
  string message = 2;
  int64 timestamp = 3;
}

message ErrorMessage {
  int32 code = 1;
  string message = 2;
  string request_id = 3;
}

enum StreamType {
  STREAM_TYPE_UNSPECIFIED = 0;
  CONTROL = 1;
  HTTP = 2;
  GRPC = 3;
  WEBSOCKET = 4;
}